---
title: "Weather Data and Time Series Emotions Among High School Students"
author: "Marty Moesta"
advisors: "Prof. Jay Emerson & Prof. Sekhar Tatikonda"
with help from: "Julia Moeller"
date: "5/4/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

The rising awareness of developing and understanding emotional intelligence in pre-college education has created a large opportunity for data scientists to uncover ways in which student's emotions are affected and the dynamic nature of their existence.  For this project, I intend to address two separate questions:  *How do emotions in high school students at time t affect their emotions at time t+1?* & *How does the weather affect student's emotions at a given time period?*  Insights gained from these analyses can affect the way teachers think about their students emotions, and further improve and optomize pre-college education.

## The Dataset and Programming Language

In order to find a dataset that would help in answering the above questions, I collaborated with Julia Moeller in the Emotional Intelligence department.  With her help, I procured a dataset of emotional responses from 472 different high school students in the Connecticut area using the Emotional Sampling Method (ESM) (18,610 responses in total).  Students were prompted to record their emotions three times per school day on their cell phone from May 9, 2016 to June 10, 2016.  The average student age was 15.8, with 71.2% of sample responses coming from females.  Grade levels are fairly equally represented, with the exception of 13.1% of responses coming from high school seniors (average: 25%).  13.8% of students came from low-income schools, and 86.2% came from middle-to-high income schools.  Students were offered a $40 Amazon gift card if they participated in more than 90% of the available surveys.  Responses were to the question: On a scale of 1 to 4, how (Emotion) do you feel in this moment?  For more information on the dataset, please see the full R Markdown script.

In answering the second part of my question, I needed to obtain detailed weather reports.  To achieve this, I requested exports from the National Oceanic and Atmospheric Association (NOAA) website: https://www.ncdc.noaa.gov/wct/.  In addition, I retrieved humidity and visibility measures from Weather Underground: https://www.wunderground.com/.  I chose to examine weather from Meriden Markham Municipal Airport and Sikorsky Municipal Airport, as one of those locations fell within 15 miles from all of the schools surveyed.

All data analysis is performed using the R statistical computing language, with RStudio as an IDE.  

**NOTE:**  For brevity's sake, some non-essential code will not be included in this document.  However, a full RMarkdown script containing all code will come attached to this report.

## Part 1: Time-Series Emotional Management

Before I would be able to run any analysis on the datset, substantial data cleaning had to be performed, in order to get the data into an operable state.  One row of data is equivalent to one survey result.

```{r read in data, echo=TRUE}
## Reading in data from SPSS file and subsetting with columns that are necessary 
## install.packages("foreign")
library(foreign) #Library that helps to read in SPSS files
options(warn=-1) #Non-vital warnings are supressed
x <- read.spss(file = "dataset.sav", to.data.frame = T)
y <- x[x$BG_OR_ESM=="ESM",]
beep <- y[,709:740]
beep[6,]  # An example of a row of data
```

Next, emotions are anonymized A-P, and a columns A2-P2 are intialized.  A2-P2 will contain a participant's emotion A-P at time *t+1*.  The **date_coded** column of the data frame will be used shortly to identify the relative date of an individuals series of responses.

```{r Anonymizing emotions, creating new columns, echo=FALSE}
## These are the new columns we are creating
beep$date_coded <- NA
beep$session_char <- as.character(beep$Session_Name)
beep$A2 <- NA
beep$B2 <- NA
beep$C2 <- NA
beep$D2 <- NA
beep$E2 <- NA
beep$F2 <- NA
beep$G2 <- NA
beep$H2 <- NA
beep$I2 <- NA
beep$J2 <- NA
beep$K2 <- NA
beep$L2 <- NA
beep$M2 <- NA
beep$N2 <- NA
beep$O2 <- NA
beep$P2 <- NA

## Renaming old columns
library(plyr)
beep <- rename(beep, c("enthusiast_ESM" = "A",
            "happy_ESM" = "B",
            "interested_ESM" = "C",
            "curious_ESM" = "D",
            "calm_ESM" = "E",
            "relaxed_ESM" = "F",
            "frustrated_ESM" = "G",
            "anxious_ESM" = "H",
            "afraid_ESM" = "I",
            "tired_ESM" = "J",
            "sad_ESM" = "K",
            "bored_ESM" = "L",
            "stressed_ESM" = "M",
            "challenge_ESM" = "N",
            "skills_ESM" = "O",
            "choice" = "P"))
```

Some entries were taken in the evening, however since the focus is to examine student's emotions in an education setting, those entries are removed.
```{r Removing evening entries, echo=FALSE}
## Removing Evening Entries
rem <- c()
for(i in 1: nrow(beep)){
  if(beep$session_char[i] == unique(beep$session_char)[2] | 
     beep$session_char[i]== unique(beep$session_char)[4]) {
    rem <- c(rem,i)
  }
}
beep <- beep[-rem,]
```

Next, the data frame is split into a list, sorted by their participant ID.  This ID is a way to collate all of the ESM responses from a given individual.
```{r Splitting Entiries By Participant, echo=TRUE }
beep2 <- split(beep,beep$Participant)
```

The loop below fills in the **date_coded** column of the data frame, starting with '1' for each survey response recorded on the day a participant began the survey.  This transormation just makes it easier to calculate *t vs. t+1* correlations. An example of date v. date coded is found below.

```{r Loop to Create Dates, echo=TRUE}
## Coding dates
M <- length(beep2) # Number of participants, 472
for(i in 1:M){
  N <- dim(beep2[[i]])[1] # Number of responses from an individual 'i'
  temp <- 1 # To signify 1st entry from a survey 
  init <- as.numeric(beep2[[i]]$Date[1]) # The first date that someone responds to a survey
  for(j in 1:N){
    tempdate <- as.numeric(beep2[[i]]$Date[j])
    if(tempdate > init){ #If the date on entry j is the next day
      init <- tempdate # The counter 'init' become the new date
      temp <- temp + 1 
    }
    beep2[[i]]$date_coded[j] <- temp
  }
}
beep2[[4]]$Date[1:10]
beep2[[4]]$date_coded[1:10]
```

Looping through each participant and then their survey responses, A2-P2 values are recorded.  If consecutive entries occur on different days, then A2-P2 are not recorded, since the interest is focused more on the within-day relationship between emotions.  Including inter-day emotional carryover could pose problems to any underlying conclusions the data may present.
```{r Filling in Emotions at t+1, echo=TRUE}
## Loop for filling in emotions at time t+1
for(i in 1:M){ # Number of participants
  N <- dim(beep2[[i]])[1] # Number of responses from participant 'i'
  if(N > 1){ # Cannot record emotion at t+1 if there is only one response
    for(j in 1:(N-1)){
      if(beep2[[i]]$date_coded[j]==
         beep2[[i]]$date_coded[j+1]){ # If the next session is in the same day
        beep2[[i]][j,35:50] <- 
          beep2[[i]][(j+1),16:31]  # Todays A2-P2 equals next session's A-P
      }
    }
  }
}
```

In order to interpret how well certain emotions are at predicting others, a coefficient matrix is created.  This matrix records all beta coefficient values of the multiple regression: $$ E_{t+1} = \beta E_t + \gamma E_t + C $$ for all emotion combinations A-P.  The coefficient gamma represents the "participant" variable and is used here to help account for any variability among particpants.  Coefficients with a significance level below 0.05 are removed.

```{r Time Series Coefficient Matrix, echo=FALSE}
## Turning the list back into a data frame so correlations can be run
df2 <- do.call(rbind.data.frame, beep2)

## Selecting only the emotions at time t and emotions at time t+1
df_final <- df2[,c(3,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,35,
                   36,37,38,39,40,41,42,43,44,45,46,47,48,49,50)]

## Creating coefficient matrix
t_val <- matrix(nrow=16,ncol=16)
regression_final <- matrix(nrow=16,ncol=16)
len <- 16
participant <- df_final$Participant
for(i in 1:len){
  temp1 <- df_final[,i+1]
  participant <- df_final$Participant
  for(j in 1:len){
    temp2 <- df_final[,j+17]
    tempdf <- data.frame(temp1,temp2,participant)
    sb <- lm(temp2 ~ temp1 + participant, data = tempdf)
    regression_final[i,j] <- sb$coefficients[2]
    sb2 <- summary(sb)[4]
    t_val[i,j] <- sb2[[1]][2,4]
  }
}
not_sig <- which(abs(t_val) > 0.05)
regression_final[not_sig] <- NA
rownames(regression_final) <- c("Enthusiastic", "Happy", "Interested", "Curious", "Calm", "Relaxed", "Frustrated",
                                "Anxious", "Afraid","Tired", "Sad", "Bored", "Stressed", "Challenged","Skilled",
                                "Choice")
colnames(regression_final) <- c("Enthusiastic2", "Happy2", "Interested2", "Curious2", "Calm2", "Relaxed2", "Frustrated2",
                                "Anxious2", "Afraid2","Tired2", "Sad2", "Bored2", "Stressed2", "Challenged2","Skilled2",
                                "Choice2")
round(regression_final,3)
```

These coefficients are now used to create a network analysis of emotions in time series.  The network was created using the corrplot package in R.  The rows are emotions at time *t* and the columns are emotions at time *t+1*


```{r Trying to make network yourself, echo=FALSE}
#install.packages("corrplot")
library(corrplot)
corrplot(regression_final,method="color", tl.col = "black")
```

What conclusions can we draw from this analysis?  First, it seems that the auto-regressions (predicting an emotion by itself in the previous time period) have the strongest beta values. In particular, negative emotions like sadness, tiredness, and stress seem to have the highest beta values when predicting themselves in the next time period.  Symmetry is also evident between the first 13 rows and columns, as a rough outline of four quadrants emerges.  Where the symmetry fails to persist, however, is when students are asked about their levels of curiousity.  Curiousity in the current period has a positive coefficient for predicting fear and sadness in the next.  In addition, feelings of anxiousness, frustration, and fear in the current period have a positive relationship to curiousity in the next.  Although this finding needs replication in other studies to substantiate itself, this could signal to educators to develop processes that help channel student's anxiety or frustration into creativity and curiousity.


## Part 2: Emotions and Weather

The next exploration hopes to glean insights about emotion dynamics at different types of weather.  It is well-documented, however, that emotions on an individual level can be caused by many things, so we must proceed with caution as we attempt to draw our conclusions.

Before the data can be analyzed, the weather dataset must be merged with the ESM dataset.  In order to merge weather data and ESM data, each ESM row was given an ID to determine which airport they would be sourcing the data from.  This ID was based off of school.  Columns were then created in the original ESM dataset to bring in the weather data.  Weather & ESM data would be matched by date, and then empty weather columns in the ESM datset would source their values from the weather data at a gien airport at a given date.

```{r Multiplot function, echo=F}
#############################  Multiple Plot Function  #############################################
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)
  
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  
  numPlots = length(plots)
  
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                     ncol = cols, nrow = ceiling(numPlots/cols))
  }
  
  if (numPlots==1) {
    print(plots[[1]])
    
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    
    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
################################ Exploration #####################################################
```
```{r Reading in dataset, echo=F}
library(foreign)
#setwd("~/Documents/EI Senior Project")

kids <- read.spss(file = "dataset.sav", to.data.frame = T)
esm <- kids[kids$BG_OR_ESM=="ESM",]
weather <- read.csv("weather.csv", as.is=T)
extra <- read.csv("weather_extra.csv", as.is=T)


#Use Meriden Markham Municipal Airport for Chesire Kids
#Use Sikorsky Memorial Airport for Trumbull, Bassick, and FW, Kids

# Just getting the data we need from the two airports
weather <- weather[weather$STATION_NAME %in% c("IGOR I SIKORSKY MEMORI AIRPORT CT US", 
                                               "MERIDEN MARKHAM MUNICIPAL AIRPORT CT US"),]

## Getting weather date into proper form
weather$date2 <- NA
weather <- transform(weather, date2 = as.Date(as.character(weather$DATE), "%Y%m%d"))
esm <- transform(esm, date2 = as.Date(as.character(esm$Date), format = "%m/%d/%Y"))



## Matching up dates on ESM and weather data

## Adding 2000 years to ESM dates
for(i in 1:nrow(esm)){
  d <- as.POSIXlt(esm$date2[i])
  d$year <- d$year + 2000
  esm$date2[i] <- d
}
esm$date2 <- as.Date(esm$date2)

## Different weather for different airports
weatherI <- weather[weather$STATION_NAME=="IGOR I SIKORSKY MEMORI AIRPORT CT US",]
weatherM <- weather[weather$STATION_NAME== "MERIDEN MARKHAM MUNICIPAL AIRPORT CT US",]

## Extra columns that were sourced from Weather Underground and not NOAA
weatherI$humidity <- extra$I_Humidity
weatherM$humidity <- extra$M_Humidity
weatherI$visibility <- extra$I_Visibility
weatherM$visibility <- extra$M_Visibility

esm$airport <- NA
esm$uID <- NA
for(i in 1:nrow(esm)){
  if(esm$SCHOOL_ESM[i]=="Chesire"){  # Chesire used weather data from Markham Airport
    esm$airport[i] <- 2
    esm$uID[i] <- which(weatherM$date2==esm$date2[i])
  }
  else{
    esm$airport[i] <- 1
    esm$uID[i] <- which(weatherM$date2==esm$date2[i])  # Other schools used data from Sikorsky Airport
  }
}

## Moving weather data into esm dataframe
esm$station <- NA
esm$precip <- NA
esm$snowdepth <- NA
esm$snowfall <- NA
esm$tempavg <- NA
esm$tempmax <- NA
esm$tempmin <- NA
esm$tempobs <- NA
esm$windavg <- NA
esm$peakgust <- NA
esm$blowingsnow <- NA
esm$fog <- NA
esm$fogheavy <- NA
esm$smoke <- NA
esm$thunder <- NA
esm$humidity <- NA
esm$visibility <- NA

for(i in 1:nrow(esm)){
  if(esm$airport[i]==1){
    esm$station[i] <- weatherI$STATION_NAME[esm$uID[i]]
    esm$precip[i] <- weatherI$PRCP[esm$uID[i]]
    esm$snowdepth[i] <- weatherI$SNWD[esm$uID[i]]
    esm$snowfall[i] <- weatherI$SNOW[esm$uID[i]]
    esm$tempavg[i] <- weatherI$TAVG[esm$uID[i]]
    esm$tempmax[i] <- weatherI$TMAX[esm$uID[i]]
    esm$tempmin[i] <- weatherI$TMIN[esm$uID[i]]
    esm$tempobs[i] <- weatherI$TOBS[esm$uID[i]]
    esm$windavg[i] <- weatherI$AWND[esm$uID[i]]
    esm$peakgust[i] <- weatherI$PGTM[esm$uID[i]]
    esm$blowingsnow[i] <- weatherI$WT09[esm$uID[i]]
    esm$fog[i] <- weatherI$WT01[esm$uID[i]]
    esm$fogheavy[i] <- weatherI$WT02[esm$uID[i]]
    esm$smoke[i] <- weatherI$WT08[esm$uID[i]]
    esm$thunder[i] <- weatherI$WT03[esm$uID[i]]
    esm$visibility[i] <- weatherI$visibility[esm$uID[i]]
    esm$humidity[i] <- weatherI$humidity[esm$uID[i]]
  }
  else{
    esm$station[i] <- weatherM$STATION_NAME[esm$uID[i]]
    esm$precip[i] <- weatherM$PRCP[esm$uID[i]]
    esm$snowdepth[i] <- weatherM$SNWD[esm$uID[i]]
    esm$snowfall[i] <- weatherM$SNOW[esm$uID[i]]
    esm$tempavg[i] <- weatherM$TAVG[esm$uID[i]]
    esm$tempmax[i] <- weatherM$TMAX[esm$uID[i]]
    esm$tempmin[i] <- weatherM$TMIN[esm$uID[i]]
    esm$tempobs[i] <- weatherM$TOBS[esm$uID[i]]
    esm$windavg[i] <- weatherM$AWND[esm$uID[i]]
    esm$peakgust[i] <- weatherM$PGTM[esm$uID[i]]
    esm$blowingsnow[i] <- weatherM$WT09[esm$uID[i]]
    esm$fog[i] <- weatherM$WT01[esm$uID[i]]
    esm$fogheavy[i] <- weatherM$WT02[esm$uID[i]]
    esm$smoke[i] <- weatherM$WT08[esm$uID[i]]
    esm$thunder[i] <- weatherM$WT03[esm$uID[i]]
    esm$humidity[i] <- weatherM$humidity[esm$uID[i]]
    esm$visibility[i] <- weatherM$visibility[esm$uID[i]]
  }
}

```

Now that the data is cleaned and merged it is time to begin exploration on the dataset. This set contains fourteen emotion measures and over twenty weather variables per observation, so we must hone our efforts.  A two-pronged exploration approach is taken: numerical and visual.  Using the mean emotion score as an initial measurement parameter, tables of means are constructed for each emotion at different: 1) average daily temperatures 2) daily humidity levels 3) daily visibility levels and 4) daily precipitation levels (rain).  Then using the ggplot2 graphics package, these means are laid out on four separate plots in an effort to narrow the lens of focus.

Below is an example of how the means are calculated and laid out at the various temperatures.  Code for other weather parameters is included in the R markdown.

```{r Mean tables at different Weather Parameters, echo =TRUE}

cols <- 17
count <- 1
temps <- unique(esm$tempavg)  # All the unique temperatures recorded
sort(temps)
em_avg_temp <- matrix(ncol = cols,nrow=length(temps)) # Creating empty matrix
for(i in temps){
  em_avg_temp[count,1] <- i # First row is the temperature
  em_avg_temp[count,2] <- length(which(esm$tempavg==i)) # Second is # of observations
  em_avg_temp[count,3:cols] <- 
    colMeans(esm[esm$tempavg==i,724:738], na.rm=T) #Column means are taken from subsetted data
  count <- count+1 # Move onto the next row in matrix
}
em_avg_temp <- em_avg_temp[order(em_avg_temp[,1]),] # Order matrix by ascending temp
em_avg_temp_df <- as.data.frame(em_avg_temp) # Make it a dataframe
colnames(em_avg_temp_df) <- c("tempavg","num_obs",names(esm)[724:738]) #Naming columns
```


### Temperature Mean Table
```{r temp mean table, echo=FALSE}
em_avg_temp_df
```

### Visibility Mean Table
```{r Vis Mean Tables, echo=FALSE}

## Means of emotions at different visiblity levels
count <- 1
temps <- unique(esm$visibility)
em_avg_vis <- matrix(ncol = cols,nrow=length(temps))
for(i in temps){
  em_avg_vis[count,1] <- i
  em_avg_vis[count,2] <- length(which(esm$visibility==i))
  em_avg_vis[count,3:cols] <- colMeans(esm[esm$visibility==i,724:738], na.rm=T)
  count <- count+1
}
em_avg_vis <- em_avg_vis[order(em_avg_vis[,1]),]
em_avg_vis_df <- as.data.frame(em_avg_vis)
colnames(em_avg_vis_df) <- c("visiblity","num_obs",names(esm)[724:738])
em_avg_vis_df
```

### Humidity Mean Table
```{r Humidity Mean Table, echo=F}
## Means of emotions at different humidity levels
count <- 1
temps <- unique(esm$humidity)
em_avg_hum <- matrix(ncol = cols,nrow=length(temps))
for(i in temps){
  em_avg_hum[count,1] <- i
  em_avg_hum[count,2] <- length(which(esm$humidity==i))
  em_avg_hum[count,3:cols] <- colMeans(esm[esm$humidity==i,724:738], na.rm=T)
  count <- count+1
}
em_avg_hum <- em_avg_hum[order(em_avg_hum[,1]),]
em_avg_hum_df <- as.data.frame(em_avg_hum)
colnames(em_avg_hum_df) <- c("humidity","num_obs",names(esm)[724:738])
em_avg_hum_df
```

### Precipitation Mean Table
```{r Precip mean table, echo=FALSE}
## Means of emotions at different rain levels
count <- 1
temps <- unique(esm$precip)
em_avg_rain <- matrix(ncol = cols,nrow=length(temps))
for(i in temps){
  em_avg_rain[count,1] <- i
  em_avg_rain[count,2] <- length(which(esm$precip==i))
  em_avg_rain[count,3:cols] <- colMeans(esm[esm$precip==i,724:738], na.rm=T)
  count <- count+1
}
em_avg_rain <- em_avg_rain[order(em_avg_rain[,1]),]
em_avg_rain_df <- as.data.frame(em_avg_rain)
colnames(em_avg_rain_df) <- c("rain","num_obs",names(esm)[724:738])
em_avg_rain_df
```

Now that mean tables have been calculated, scatterplots are created to better analyze interesting trends.

```{r Mean Emotion plots, echo=FALSE}
## MAKING MEAN TEMPERATURE/EMOTION PLOTS
library(ggplot2)

## Remove temps that had less than 100 observations
count <- NULL
for(i in 1:nrow(em_avg_temp_df)){
  if(em_avg_temp_df$num_obs[i] < 100){
    count <- c(count,i)
  }
}
if(length(count) >0){
em_avg_temp_df <- em_avg_temp_df[-count,]
}

## Column of all emotions means
means1 <- c(em_avg_temp_df$enthusiast_ESM,em_avg_temp_df$happy_ESM,em_avg_temp_df$calm_ESM,
            em_avg_temp_df$tired_ESM, em_avg_temp_df$sad_ESM, em_avg_temp_df$bored_ESM,
            em_avg_temp_df$stressed_ESM)

## Column of which column each mean was in for colors
len <- nrow(em_avg_temp_df)
Emotions <- rep(NA,len*7)
Emotions[1:len] <- "Enthusiastic"
Emotions[(len+1): (2*len)] <- "Happy"
Emotions[(2*len + 1):(3*len)] <- "Calm"
Emotions[(3*len + 1):(4*len)] <- "Tired"
Emotions[(4*len + 1 ):(5*len)] <-"Sad"
Emotions[(5*len + 1):(6*len)] <-"Bored"
Emotions[(6*len + 1):(7*len)] <- "Stressed"

## Temperature column
celsius <- rep(em_avg_temp_df$tempavg,7)

## Repitions of the num of observations for sizing of points
obs <- rep(em_avg_temp_df$num_obs,7)

## Make the data frame
df1 <- data.frame(celsius,obs,Emotions,means1)

## Making the temperature emotions plot
p1 <- ggplot(df1,aes(celsius,means1, colour = Emotions))
p1 <- p1 + geom_point(aes(size=obs)) + geom_line() + ggtitle("Mean Emotions at Different Temperature Levels") +
  xlab("Temperature (in F)") + ylab("Emotion Levels (1 to 4)") + 
  scale_size(name="Number of Observations")
p1

## MAKING MEAN HUMIDITY/EMOTION PLOTS

## Remove temps that had less than 100 observations
count <- NULL
for(i in 1:nrow(em_avg_hum_df)){
  if(em_avg_hum_df$num_obs[i] < 100){
    count <- c(count,i)
  }
}
if(length(count)>0){
em_avg_hum_df <- em_avg_hum_df[-count,]
}
## Column of all emotions means
means2 <- c(em_avg_hum_df$enthusiast_ESM,em_avg_hum_df$happy_ESM,em_avg_hum_df$calm_ESM,
            em_avg_hum_df$tired_ESM, em_avg_hum_df$sad_ESM, em_avg_hum_df$bored_ESM,
            em_avg_hum_df$stressed_ESM)

## Column of which column each mean was in for colors
len <- nrow(em_avg_hum_df)
Emotions <- rep(NA,len*7)
Emotions[1:len] <- "Enthusiastic"
Emotions[(len+1): (2*len)] <- "Happy"
Emotions[(2*len + 1):(3*len)] <- "Calm"
Emotions[(3*len + 1):(4*len)] <- "Tired"
Emotions[(4*len + 1 ):(5*len)] <-"Sad"
Emotions[(5*len + 1):(6*len)] <-"Bored"
Emotions[(6*len + 1):(7*len)] <- "Stressed"

## Temperature column
hume <- rep(em_avg_hum_df$humidity,7)

## Repitions of the num of observations for sizing of points
obs <- rep(em_avg_hum_df$num_obs,7)

## Make the data frame
df1 <- data.frame(hume,obs,Emotions,means2)

## Making the humidity emotions plot
p2 <- ggplot(df1,aes(hume,means2, colour = Emotions))
p2 <- p2 + geom_point(aes(size=obs)) + geom_line() + ggtitle("Mean Emotions at Different Humidity Levels") +
  xlab("Humidity (in %)") + ylab("Emotion Levels (1 to 4)") + scale_size(name="Number of Observations")

p2

## MAKING MEAN VISIBILITY/EMOTION PLOTS

## Remove temps that had less than 100 observations
count <- NULL
for(i in 1:nrow(em_avg_vis_df)){
  if(em_avg_vis_df$num_obs[i] < 100){
    count <- c(count,i)
  }
}
if(length(count)>0){
  em_avg_vis_df <- em_avg_vis_df[-count,]
}
## Column of all emotions means
means3 <- c(em_avg_vis_df$enthusiast_ESM,em_avg_vis_df$happy_ESM,em_avg_vis_df$calm_ESM,
            em_avg_vis_df$tired_ESM, em_avg_vis_df$sad_ESM, em_avg_vis_df$bored_ESM,
            em_avg_vis_df$stressed_ESM)

## Column of which column each mean was in for colors
len <- nrow(em_avg_vis_df)
Emotions <- rep(NA,len*7)
Emotions[1:len] <- "Enthusiastic"
Emotions[(len+1): (2*len)] <- "Happy"
Emotions[(2*len + 1):(3*len)] <- "Calm"
Emotions[(3*len + 1):(4*len)] <- "Tired"
Emotions[(4*len + 1 ):(5*len)] <-"Sad"
Emotions[(5*len + 1):(6*len)] <-"Bored"
Emotions[(6*len + 1):(7*len)] <- "Stressed"

## Temperature column
viz <- rep(em_avg_vis_df$visiblity,7)

## Repitions of the num of observations for sizing of points
obs <- rep(em_avg_vis_df$num_obs,7)

## Make the data frame
df1 <- data.frame(viz,obs,Emotions,means3)

## Making the visibility emotions plot
p3 <- ggplot(df1,aes(viz,means3, colour = Emotions))
p3 <- p3 + geom_point(aes(size=obs)) + geom_line() + ggtitle("Mean Emotions at Different Visibility Levels") +
  xlab("Visbility (in miles)") + ylab("Emotion Levels (1 to 4)") + scale_size(name="Number of Observations")

p3

## MAKING MEAN PRECIPITATION/EMOTION PLOTS

## Remove temps that had less than 100 observations
count <- NULL
for(i in 1:nrow(em_avg_rain_df)){
  if(em_avg_rain_df$num_obs[i] < 100){
    count <- c(count,i)
  }
}
if(length(count)>0){
  em_avg_rain_df <- em_avg_rain_df[-count,]
}
## Column of all emotions means
means4 <- c(em_avg_rain_df$enthusiast_ESM,em_avg_rain_df$happy_ESM,em_avg_rain_df$calm_ESM,
            em_avg_rain_df$tired_ESM, em_avg_rain_df$sad_ESM, em_avg_rain_df$bored_ESM,
            em_avg_rain_df$stressed_ESM)

## Column of which column each mean was in for colors
len <- nrow(em_avg_rain_df)
Emotions <- rep(NA,len*7)
Emotions[1:len] <- "Enthusiastic"
Emotions[(len+1): (2*len)] <- "Happy"
Emotions[(2*len + 1):(3*len)] <- "Calm"
Emotions[(3*len + 1):(4*len)] <- "Tired"
Emotions[(4*len + 1 ):(5*len)] <-"Sad"
Emotions[(5*len + 1):(6*len)] <-"Bored"
Emotions[(6*len + 1):(7*len)] <- "Stressed"

## Temperature column
rain <- rep(em_avg_rain_df$rain,7)

## Repitions of the num of observations for sizing of points
obs <- rep(em_avg_rain_df$num_obs,7)

## Make the data frame
df1 <- data.frame(rain,obs,Emotions,means4)

## Making the rain emotions plot
p4 <- ggplot(df1,aes(rain,means4, colour = Emotions))
p4 <- p4 + geom_point(aes(size=obs)) + geom_line() + ggtitle("Mean Emotions at Different Rain Levels") +
  xlab("Rain (in inches)") + ylab("Emotion Levels (1 to 4)") + scale_size(name="Number of Observations")

#install.packages("psych")
library(psych)  # A library that can record the within-group correlation

p4

```

This exploration provides many opportunities worth pursuing, however, two will be considered here: 1) The seemingly indirect relationship between "tiredness" and temperature, and 2) The relationship between high levels calmness and enthusiasm in juxtaposition to low levels of stress and boredom as visibility decreases and amount of precipitation increases.

### 2.1 Tiredness v. Temperature

Revisiting the temperature vs. emotions plot, it seems that levels of tiredness generally decrease with an increase in temperature, but is this a truly valuable finding?  Is it anything more than random noise in the data?  Could it be caused by something other than an increase in temperature?  The following section will examine these questions. 

Before trying to uncover lurking variables in the data, one must determine if this finding is within in the realm of what we could expect from the data if it were truly random.  In order to investigate this, a permutation test is conducted, examining the correlation between the two variables in question.  The permutation test will rearrange the vector of responses to the question "How tired do you feel right now?" without replacement, while leaving the vector of temperatures intact.  Then the correlation will be measured between the random vector of tiredness scores and their given termperatures.  This process will be permuted 1000 times, at which point the distribution of correlations with be compared to the within-groups correlation of the actual data.

```{r Within group correlation, echo=TRUE}

a <- esm$tired_ESM
b <- esm$tempavg
c <- esm$Participant
alpha <- data.frame(a,b,c)
pack <- statsBy(alpha,group = "c")
s_star <- pack$rwg[2]
s_star  # Within-group correlation
```
Generally speaking, a correlation measures how strongly pairs of varaibles are related.  A correlation of -0.07 may seem small, but it is important to interpret this within the context of what would be an expected correlation if the data was truly random. There are many ways to calculate a correlation.  When dealing with survey data from many participants, two types of correlations emerge: within-group correlation and between-group correlation.  The former measures the relationship between temperature and tiredness *within* individuals across situations.  The latter accounts for differences in personality *between* individuals, and reflects the components of emotions that remain stable across a situation but differ from person to person.  Since the investigation wants to examine how individuals vary *across situations*, the within-group correlation is the important statistic.  When running a permutation test, since responses are randomized across participants, one no longer has to account for between-group correlation and can just use the default Pearson Correlation.


```{R perm test, echo=F}
a <- esm$tired_ESM
b <- esm$tempavg
c <- esm$Participant
alpha <- data.frame(a,b,c)

reps <- 1000
s_perm <- rep(NA,reps)
for(i in 1:reps){
  t_tired <- sample(esm$tired_ESM,replace = F)
  participant <- esm$Participant
  t_temps <- esm$tempavg
  t_df <- data.frame(t_tired,t_temps, participant)
  s_perm[i] <- cor(t_tired, t_temps, use = "complete.obs")
}
## Plot the permutation test histogram
s_perm <- as.data.frame(s_perm)
names(s_perm) <- "perms"
library(RColorBrewer)
myColors <- brewer.pal(8,"Set2")
h1 <- ggplot(s_perm, aes(perms)) + geom_histogram(binwidth = .0006, fill = myColors[8]) +
  geom_vline(aes(xintercept = s_star), colour = myColors[1], size = 3) + theme(legend.position="none") +
  xlab("Correlation between Temperature and Tiredness (From 53 degrees to 74 degrees)") +
  ggtitle("Permutation Test Results")

h1
```

In the figure above, the green line is the test statistic, while the histogram to its right represents the distribution of correlations one could expect to find if the distribution of the data was truly random.  Since the actual correlation falls well outside the scope of simulated correlations, there is evidence that this trend is more than mere "noise" in the data.

As mentioned earlier, emotions, among high-school students, can be caused by a variety of factors, and this dataset does not provide the entire picture.  However, there are still ways of examining other phenomena that, under the surface, could be the real cause for the trend we are seeing.

A consideration must be made to examine *date* as a lurking variable in this analysis.  It could be possible, that this decrease in level of tiredness could be because students are getting towards the end of school, and are getting excited for summer, which also reflects itself in rising temperatures.

```{r Setting up Dates and Stuff, echo =FALSE}
dates <- unique(esm$date2)
tired_scores <- rep(NA,length(dates))
observations <- rep(NA,length(dates))
tempers <-  rep(NA,length(dates))
for(i in 1:length(dates)){
  find <- which(esm$date2==dates[i])
  tired_scores[i] <- mean(esm$tired_ESM[find], na.rm = T)
  observations[i] <- length(esm$tired_ESM[find]) - length(which(is.na(esm$tired_ESM[find])))
  tempers[i] <- mean(esm$tempavg[find])
}

## Remove row if number of observations is below 100 (run this chunk together)
tired_df <- data.frame(dates,tired_scores,observations, tempers)
count <- NULL
for(i in 1:nrow(tired_df)){
  if(tired_df$observations[i]< 100){
    count <- c(count,i)
  }
}
tired_df <- tired_df[-count,]

## Making an average day column for regression purposes later
em_avg_temp_df$datecol <- rep(NA,nrow(em_avg_temp_df))
for(i in 1:nrow(em_avg_temp_df)){
  em_avg_temp_df$datecol[i] <- mean(as.numeric(esm$date2[esm$tempavg==em_avg_temp_df$tempavg[i]]))
}


```


```{r Temp vs. Date, echo = FALSE}

## Compare how tiredness changes with date
t1 <- ggplot(tired_df,aes(dates,tired_scores))
t1 <- t1 + geom_point(size=3) + 
  geom_line() + ylim(c(2.2,3)) + ggtitle("Mean Tired Scores at Different Dates") +
  xlab("Date") + ylab("Mean Tired Score (1 to 4)")

tempa <- em_avg_temp_df$tempavg
tempb <- em_avg_temp_df$tired_ESM
temp_df <- data.frame(tempa,tempb)
p_tired <- ggplot(temp_df,aes(tempa,tempb))
p_tired <- p_tired + geom_point(size=3) + geom_line() + ggtitle("Mean Tired at Different Temperatures") +
  xlab("Temperature (in F)") + ylab("Emotion Levels (1 to 4)") + 
  scale_size(name="Number of Observations") + ylim(c(2.2,3)) 


dt_fit <- lm(tempavg ~ date2, data = esm)  ##R^2 = 0.58
dt1 <- ggplot(esm,aes(x =date2,y = tempavg)) + geom_point() + ggtitle("Temperature Predicted By Date") + xlab("Dates") + 
  ylab("Temperature (in F)") +
  stat_smooth(method = "lm", col = "green") 

multiplot(p_tired,t1, dt1, cols=2)
```
The plots above show that the trend found among tired means at different temperatures is similar to the means at different days (as students get closer and closer to the end of school).  However, the variables may confound one another, as the linear regression on the right shows a positive relationship between dates and temperatures (with R^2 = 0.58).  To investigate further, regressions on the means at given temperatures and dates are performed.

```{r Regression on Temps and Dates, echo=TRUE}

## Regressions of temp and date trying to predict avg level of tired per day
fit_temp <- lm(tired_ESM ~ tempavg, data = em_avg_temp_df)  
## Predicting mean_tired scores based off of temperature
fit_temp2 <- lm(tired_ESM ~ tempavg + datecol, data = em_avg_temp_df)
summary(fit_temp)$r.squared 

fit_date <- lm(tired_scores ~ dates + tempers , data = tired_df) 
# Accounting for within day differences in temperature
fit_date2 <- lm(tired_scores ~ dates, data = tired_df) 
# Day predicting tired means

summary(fit_date)$r.squared 


fit_temp$coefficients
fit_temp2$coefficients
fit_date2$coefficients
fit_date$coefficients
```
The purpose of performing these regressions is not necessarily to create a model that predicts emotional scores to a satisfactory level.  Instead, operating on the assumption that emotions on the individual level are complicated to anticipate, the models help examine the predictive power of the variables in question.  First, examining the R^2^ for both models, the *fit_temp* model has a higher value.  That means that more of variance in the data is explained by the *fit_temp* model over the *fit_date* model.  When the models begin to control for the lurking coefficients, it hampers their respective strength.  Both parameters lose some of their predictive power when controlling for the other variable, which could mean that *both* temperature and date are affecting levels of tiredness.


```{r plots for regression, echo=F}

fit2 <- ggplot(tired_df, aes(x=dates, y = tired_scores)) + geom_point() + 
  stat_smooth(method = "lm", col = "blue") + ggtitle("Tired Means Predicted By Date") + ylab("Mean Tired Score") +
  xlab("Date")
fit1 <- ggplot(em_avg_temp_df, aes(x=tempavg, y = tired_ESM)) + geom_point() + 
  stat_smooth(method = "lm", col = "red") + ggtitle("Tired Means Predicted By Temp") +ylab("Mean Tired Score") +
  xlab("Temperature")

multiplot(fit1,fit2,cols = 2)

```

Using the *stat_smooth* method in the ggplot package in R, the graphs above show a narrower margin of error for the temperature regression than the date regression, as what was expected by earlier findings with the R^2^.

So what conclusions can be drawn from this analysis?  First, what is occuring in the dataset is more than just due to random variance that can be expected during sampling, as made evident by the permutation test.  So if something special is going on here, what is causing it?  Regression analysis would point to temperature and date each having some effect on how tired a student reports he or she is feeling, however, the two are entangled in such a fashion that makes it difficult to determine exactly which one has the stronger effect.

## Part 2: Rainy Day Emotions

When examining the means at different visibility and precipitation levels, one may find an interesting (possibly counter-intuitive) trend: students show higher levels of calm and enthusiasm and lower levels of stress and boredom when visibility is low (cloudy) and precipitation is high.  Before going further it important to make sure that the low visibility and high precipitation are occuring on the same day(s).
```{r table of vis and precip, echo=F}
table(esm$visibility,esm$precip)

```

Good, it looks like the day of low visibility occurs on the same day as high rain levels.  In addition, having a high *n* number of observations (834) lowers the margin of error in the sample and lets one make conclusions about this finding with greater certainty.

Next, the data is grouped into two categories: 1) Med/High visibility, little to no rain and 2) Low visibility, moderate/heavy rain.  Grouping the data into two categories provides several advantages.  For one, a two-sample t-test is conducted on the populations for all the different emotions.


**Calmness t-test**
```{r T-Test for calm, echo=TRUE}
#Significant
t.test(esm$calm_ESM[esm$visibility==5],esm$calm_ESM[esm$visibility!=5])
```


**Enthusiasm t-test p-value**
```{r t-test for enthusiasm, echo=F}
#Not significant
t.test(esm$enthusiast_ESM[esm$visibility==5],esm$enthusiast_ESM[esm$visibility!=5])$p.val
```

**Stress t-test p-value**
```{r Stressed t-test, echo=F}
# Significant
t.test(esm$bored_ESM[esm$visibility==5],esm$bored_ESM[esm$visibility!=5])$p.val
```

**Bored t-test p-value**
```{r Bored t-test, echo=FALSE}
#Significant
t.test(esm$stressed_ESM[esm$visibility==5],esm$stressed_ESM[esm$visibility!=5])$p.val
```


The data can be subset by visibility==5 or precip==1.23 since all of the observations for each overlap with one another.  The t-test confirms some of the original suscipicions.  The two-sample test determines whether or not the two group means are truly different from one another.  The test produces a 95% confidence interval of the difference between the means.  If this interval contains zero, then it can be said with 95% confidence that the sample means may not be different.  This would result in a p-value greater than 0.05, the significance level.  The p-value can be interpreted as the odds that a dataset with these group means would appear, given that the sample means are the same.  If the p-value is below 0.05, then it can be argued that the sample means are not the same.

The tests show that group means for stress, boredom and calmness are significant, but enthusiasm is not, so it will be removed from further analysis.

Since the rainy day data is collated from only one day, some concerns arise.  Could the change in mood be caused by something else that happened that day at school?  One way to investigate this is to determine if preliminary findings are consistent with results *across schools*.  Below is a table of number of responses from each school on the rainy day (Code is in the RMarkdown):

```{r Rainy day num of responses table, echo=FALSE}
table(esm$SCHOOL_ESM[esm$precip>1])
```

It looks like Trumbull, Cheshire, and Fairchild will have enough a high enough *n* to feel confident about rainy day emotion levels, however Bassick only had 10 respondents, so results there are not as reliable, however they will still be included.  The graphs below investigate the differences in emotions among schools in rainy day vs. no rainy day.

```{r Rainy day graphs, echo =FALSE}
## Was this CALM finding consistent across schools?
calm_means <- rep(NA, 8)
skool <- unique(esm$SCHOOL_ESM)
esm$rain_b <- rep(0,nrow(esm))
for(i in 1:nrow(esm)){
  if(esm$precip[i]>1){
    esm$rain_b[i] <- 1
  }
}
drip <- factor(unique(esm$rain_b))
  for(j in 0:(length(skool)-1)){
    for(k in 1:length(drip)){
      calm_means[(2*j) + k] <- mean(esm$calm_ESM[esm$SCHOOL_ESM==skool[j+1] & esm$rain_b==drip[k]], na.rm=T)
    }
  }
skool2 <- factor(c("Bassick (n=10)", "Bassick (n=10)", "Trumbull (n=608)", "Trumbull (n=608)",
            "Cheshire (n=143)", "Cheshire (n=143)", "Fairchild (n=73)", "Fairchild (n=73)"), levels = c("Bassick (n=10)","Trumbull (n=608)", "Cheshire (n=143)","Fairchild (n=73)"))

drip2 <- rep(drip,4)
calms <- data.frame(calm_means,skool2,drip2)

## Was this TIRED finding consistent across schools?
tired_means <- rep(NA, 8)
drip <- unique(esm$rain_b)
for(j in 0:(length(skool)-1)){
  for(k in 1:length(drip)){
    tired_means[(2*j) + k] <- mean(esm$tired_ESM[esm$SCHOOL_ESM==skool[j+1] & esm$rain_b==drip[k]], na.rm=T)
  }
}
tireds<- data.frame(tired_means,skool2,drip2)

## Was this BORED finding consistent across schools?
bored_means <- rep(NA, 8)
for(j in 0:(length(skool)-1)){
  for(k in 1:length(drip)){
    bored_means[(2*j) + k] <- mean(esm$bored_ESM[esm$SCHOOL_ESM==skool[j+1] & esm$rain_b==drip[k]], na.rm=T)
  }
}
boreds<- data.frame(bored_means,skool2,drip2)


## Was this STRESSED finding consistent across schools?
stressed_means <- rep(NA, 8)
for(j in 0:(length(skool)-1)){
  for(k in 1:length(drip)){
    stressed_means[(2*j) + k] <- mean(esm$stressed_ESM[esm$SCHOOL_ESM==skool[j+1] & esm$rain_b==drip[k]], na.rm=T)
  }
}
stresseds <- data.frame(stressed_means,factor(skool2),drip2)


## Bar graph time, mean levels across different schools for RAIN/NOTRAIN

bc <- ggplot(data=calms,aes(x=skool2,y = calm_means, fill=drip2)) +
  geom_bar(stat="identity", position=position_dodge()) + ggtitle("Calm Means Across Schools in No Rain v. Rain") +
  scale_fill_manual(values = c(myColors[8],myColors[1]),name="Weather",
                    breaks=c("0", "1"),
                    labels=c("No Rain", "Rain")) + scale_y_continuous(breaks = seq(0,3,by=0.5)) +
  ylab("Mean Calm Levels") + xlab("Schools") +
  geom_text(aes(label=round(tired_means,3)), position=position_dodge(width=0.9), vjust=-0.25) 


bt <- ggplot(data=tireds,aes(x=skool2,y = tired_means, fill=drip2)) +
  geom_bar(stat="identity", position=position_dodge()) + ggtitle("Tired Means Across Schools in No Rain v. Rain") +
  scale_fill_manual(values = c(myColors[8],myColors[1]),name="Weather",
                    breaks=c("0", "1"),
                    labels=c("No Rain", "Rain")) + scale_y_continuous(breaks = seq(0,3,by=0.5))  + ylab("Mean Tired Levels") + xlab("Schools") +
  geom_text(aes(label=round(tired_means,3)), position=position_dodge(width=0.9), vjust=-0.25) 


bb <- ggplot(data=boreds,aes(x=skool2,y = bored_means, fill=drip2)) +
  geom_bar(stat="identity", position=position_dodge()) + ggtitle("Bored Means Across Schools in No Rain v. Rain") +
  scale_fill_manual(values = c(myColors[8],myColors[1]),name="Weather",
                    breaks=c("0", "1"),
                    labels=c("No Rain", "Rain")) + scale_y_continuous(breaks = seq(0,3,by=0.5)) +
 ylab("Mean Bored Levels") + xlab("Schools") +
  geom_text(aes(label=round(bored_means,3)), position=position_dodge(width=0.9), vjust=-0.25) 


bs <- ggplot(data=stresseds,aes(x=skool2,y = stressed_means, fill=drip2)) +
  geom_bar(stat="identity", position=position_dodge()) + ggtitle("Stressed Means Across Schools In Rain v. No Rain") +
  scale_fill_manual(values = c(myColors[8],myColors[1]),name="Weather",
                    breaks=c("0", "1"),
                    labels=c("No Rain", "Rain")) + scale_y_continuous(breaks = seq(0,3,by=0.5)) +  
 ylab("Mean Stressed Levels") + xlab("Schools") +
  geom_text(aes(label=round(stressed_means,3)), position=position_dodge(width=0.9), vjust=-0.25) 

bc
bb
bs

## T-tests for everything

tc1 <- t.test(esm$calm_ESM[esm$precip>1 & esm$SCHOOL_ESM=="Trumbull"],esm$calm_ESM[esm$precip<1 & esm$SCHOOL_ESM=="Trumbull"])
tc2 <- t.test(esm$calm_ESM[esm$precip>1 & esm$SCHOOL_ESM=="Cheshire"],esm$calm_ESM[esm$precip<1 & esm$SCHOOL_ESM=="Cheshire"])
tc3 <- t.test(esm$calm_ESM[esm$precip>1 & esm$SCHOOL_ESM=="Fairchild"],esm$calm_ESM[esm$precip<1 & esm$SCHOOL_ESM=="Fairchild"])
ts1 <- t.test(esm$stressed_ESM[esm$precip>1 & esm$SCHOOL_ESM=="Trumbull"],esm$stressed_ESM[esm$precip<1 & esm$SCHOOL_ESM=="Trumbull"])
ts2 <- t.test(esm$stressed_ESM[esm$precip>1 & esm$SCHOOL_ESM=="Cheshire"],esm$stressed_ESM[esm$precip<1 & esm$SCHOOL_ESM=="Cheshire"])
ts3 <- t.test(esm$stressed_ESM[esm$precip>1 & esm$SCHOOL_ESM=="Fairchild"],esm$stressed_ESM[esm$precip<1 & esm$SCHOOL_ESM=="Fairchild"])
tb1 <- t.test(esm$bored_ESM[esm$precip>1 & esm$SCHOOL_ESM=="Trumbull"],esm$bored_ESM[esm$precip<1 & esm$SCHOOL_ESM=="Trumbull"])
tb2 <- t.test(esm$bored_ESM[esm$precip>1 & esm$SCHOOL_ESM=="Cheshire"],esm$bored_ESM[esm$precip<1 & esm$SCHOOL_ESM=="Cheshire"])
tb3 <- t.test(esm$bored_ESM[esm$precip>1 & esm$SCHOOL_ESM=="Fairchild"],esm$bored_ESM[esm$precip<1 & esm$SCHOOL_ESM=="Fairchild"])

```

All non-Bassick mean differences are significant at the 0.05 level except for calmness levels in Fairchild and stress levels in Cheshire.  See the R Markdown for all relevant t-tests.  These graphs and tests show, that in large part, the trends in calmness, stress, and boredom are consistent across schools, which helps respond to the concern that these findings could be due to something else going on at school that day.  If that were the case, something simlar would have had to occur across other schools in Connecticut, which is more unlikely.

The t tests performed above compared students who took the survey during the rain to all students in a given school.  In order to generalize the findings found to *all* students across *every* school, it must be shown that there is nothing out of the ordinary about the group of students who responded during the rainy day in comparison to the rest of the students at their school.  If it can be shown that the students who responded during the rainy day generally feel the same levels of calmness, stress and boredom as all other students during the non-rainy days, the conclusions made here can be generalized to high school students across Connecticut.
```{r Non-rain students v rain students when its nice out, echo =F}

rainp <- unique(esm$Participant[esm$precip>1])

## Are calm scores of rain respondents the same as regular respondents when weather is nice
rainpT_calm <- esm$calm_ESM[esm$precip<1 & esm$Participant %in% rainp & esm$SCHOOL_ESM=="Trumbull"]
norainpT_calm <- esm$calm_ESM[esm$precip<1  & esm$SCHOOL_ESM=="Trumbull"]
rainpC_calm <- esm$calm_ESM[esm$precip<1 & esm$Participant %in% rainp & esm$SCHOOL_ESM=="Cheshire"]
norainpC_calm <- esm$calm_ESM[esm$precip<1 &  esm$SCHOOL_ESM=="Cheshire"]
rainpF_calm <- esm$calm_ESM[esm$precip<1 & esm$Participant %in% rainp & esm$SCHOOL_ESM=="Fairchild"]
norainpF_calm <- esm$calm_ESM[esm$precip<1 & esm$SCHOOL_ESM=="Fairchild"]

testCT <- t.test(rainpT_calm,norainpT_calm)
testCC <- t.test(rainpC_calm, norainpC_calm)
testCF <- t.test(rainpF_calm,norainpF_calm)


## Are bored scores of rain respondents the same as regular respondents when weather is nice
rainpT_bored <- esm$bored_ESM[esm$precip<1 & esm$Participant %in% rainp & esm$SCHOOL_ESM=="Trumbull"]
norainpT_bored <- esm$bored_ESM[esm$precip<1  & esm$SCHOOL_ESM=="Trumbull"]
rainpC_bored <- esm$bored_ESM[esm$precip<1 & esm$Participant %in% rainp & esm$SCHOOL_ESM=="Cheshire"]
norainpC_bored <- esm$bored_ESM[esm$precip<1 &  esm$SCHOOL_ESM=="Cheshire"]
rainpF_bored<- esm$bored_ESM[esm$precip<1 & esm$Participant %in% rainp & esm$SCHOOL_ESM=="Fairchild"]
norainpF_bored<- esm$bored_ESM[esm$precip<1 & esm$SCHOOL_ESM=="Fairchild"]

testBT <- t.test(rainpT_bored,norainpT_bored)
testBC <- t.test(rainpC_bored,norainpC_bored)
testBF <- t.test(rainpF_bored,norainpF_bored)

## Are stress scores of rain respondents the same as regular respondents when weather is nice
rainpT_stressed <- esm$stressed_ESM[esm$precip<1 & esm$Participant %in% rainp & esm$SCHOOL_ESM=="Trumbull"]
norainpT_stressed <- esm$stressed_ESM[esm$precip<1  & esm$SCHOOL_ESM=="Trumbull"]
rainpC_stressed <- esm$stressed_ESM[esm$precip<1 & esm$Participant %in% rainp & esm$SCHOOL_ESM=="Cheshire"]
norainpC_stressed <- esm$stressed_ESM[esm$precip<1 &  esm$SCHOOL_ESM=="Cheshire"]
rainpF_stressed <- esm$stressed_ESM[esm$precip<1 & esm$Participant %in% rainp & esm$SCHOOL_ESM=="Fairchild"]
norainpF_stressed <- esm$stressed_ESM[esm$precip<1 & esm$SCHOOL_ESM=="Fairchild"]

testST <- t.test(rainpT_stressed,norainpT_stressed)
testSC <- t.test(rainpC_stressed,norainpC_stressed)
testSF <- t.test(rainpF_stressed,norainpF_stressed)
```

**P Values for Calmness at Cheshire, Farichild, and Trumbull**
```{r Calmness ps, echo=F}
testCC$p.value
testCF$p.value
testCT$p.value
```

**P Values for Stress at Cheshire, Farichild, and Trumbull**
```{r Stress ps, echo=F}
testSC$p.value
testSF$p.value
testST$p.value
```

**P Values for Boredom at Cheshire, Farichild, and Trumbull**
```{r Bored ps, echo=F}
testBC$p.value
testBF$p.value
testBT$p.value
```

As shown above, all p-values are above the significance level 0.05.  This means that it cannot be said, with any degree of certainty, that the calmness, stress, and boredom levels of students who took the survey during the rainy day are different than all of the survey respondents at a given school.  More generally, it can be said that the population of students who took the survey during the rainy day are a fair representation of the students at a school, and since findings were fairly consistent across schools (with two exceptions), one could make the arguement for the initial findings being indicitive of Connecticut high school students.

This finding, if true, has implications in many classrooms.  It may seem intuitive that students posses a generally lower emotional disposition during days of "bad weather", however this finding challenges that and claims that students are calmer and less stressed during rainy days, but also less bored, and therefore primed better for learning and challenges.  It may also mean challenging other commonly held beliefs about emotions and weather.


## Further Steps

A lot of the conlusions made by this analysis have limitations.  For one, findings from this study may not generalize to national education, since students from different climates are not included.  For example, consider the way students in Washington react to rain vs. students in Arizona.  In addition, although grade levels are fairly equally represented, genders are not.  Finally, as has been already mentioned, emotions are caused by many different external and internal factors, and limitations of this dataset make it difficult to control for all of them.

This analysis does, however, provide more direction for further studies.  Exploratory analysis, substantiated by further statistical tests, have shown that there is some relationship between tiredness and temperature within a certain temperature range, as well as calmness, boredom, and stress (and possibly enthusiasm) during rainy days.  Further studies could focus on these scenarios, as well as record survey data from multiple states, in order to defend findings that could become the building blocks for change in national education policy.